#!/bin/bash -e

export KERNEL_VERSION=5.11.14


echo "[+] Building kernel..."
# make -C linux-$KERNEL_VERSION defconfig
echo "CONFIG_NET_9P=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NET_9P_DEBUG=n" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_9P_FS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_9P_FS_POSIX_ACL=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_9P_FS_SECURITY=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NET_9P_VIRTIO=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_PCI=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_BLK=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_BLK_SCSI=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_NET=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_CONSOLE=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_HW_RANDOM_VIRTIO=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DRM_VIRTIO_GPU=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_PCI_LEGACY=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_BALLOON=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_VIRTIO_INPUT=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_CRYPTO_DEV_VIRTIO=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_BALLOON_COMPACTION=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_PCI=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_PCI_HOST_GENERIC=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_GDB_SCRIPTS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_INFO=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_INFO_REDUCED=n" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_INFO_SPLIT=n" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_FS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_INFO_DWARF4=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_DEBUG_INFO_BTF=n" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_FRAME_POINTER=y" >> linux-$KERNEL_VERSION/.config

echo "CONFIG_USER_NS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NET_NS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_COMPAT=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_IPTABLES=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_FILTER=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_MANGLE=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_NAT=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_RAW=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_SECURITY=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_IP_NF_**=y" >> linux-$KERNEL_VERSION/.config

echo "CONFIG_NETFILTER_NETLINK=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NETFILTER_XTABLES=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NETFILTER_XT_MATCH_U32=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NETFILTER_**=y" >> linux-$KERNEL_VERSION/.config

echo "CONFIG_E1000=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_E1000E=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_NET_SOCK_MSG=y" >> linux-$KERNEL_VERSION/.config

echo "CONFIG_RPMSG=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_RPMSG_NS=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_RPMSG_QCOM_GLINK=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_RPMSG_QCOM_GLINK_RPM=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_RCONFIG_RPMSG_VIRTIOPMSG=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_BRCMFMAC_PROTO_MSGBUF=y" >> linux-$KERNEL_VERSION/.config

echo "CONFIG_ALTERA_MSGDMA=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_RPMSG_CHAR=y" >> linux-$KERNEL_VERSION/.config
echo "CONFIG_PSTORE_DEFAULT_KMSG_BYTES=10240" >> linux-$KERNEL_VERSION/.config

make -C linux-$KERNEL_VERSION -j16 bzImage