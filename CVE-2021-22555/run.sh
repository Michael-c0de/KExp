#!/bin/bash

#
# build root fs
#

pushd fs
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../initramfs.cpio.gz
popd

/usr/bin/qemu-system-x86_64 \
    -m 512M \
    -nographic \
    -no-reboot \
    -kernel "./linux-5.11.14/arch/x86/boot/bzImage" \
    -append "console=ttyS0 quiet nokaslr"\
    -initrd ./initramfs.cpio.gz \
    -cpu kvm64,+smep,+smap \
    -smp cores=1 \
    -s
