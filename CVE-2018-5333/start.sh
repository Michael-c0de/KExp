#!/bin/bash

#
# build root fs
#
pushd fs
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../initramfs.cpio.gz
popd

/usr/bin/qemu-system-x86_64 \
        -kernel ./linux-4.12.6/arch/x86/boot/bzImage \
        -initrd ./initramfs.cpio.gz \
        -append "root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr" \
        -cpu qemu64,+smep \
        -s \
        -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
        -nographic \
        -monitor none \
        -no-reboot
